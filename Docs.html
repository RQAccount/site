<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <meta name="format-detection" content="telephone=no,email=no" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge, chrome=1">
  <meta name="description" content="description of your site">
  <meta name="author" content="author of the site">
  <title>Bigview 文档</title>
  <link rel="stylesheet" href="source/main.css"/>
  
  
    
        <link rel="stylesheet" href="./style/a.css"/>
    
        <link rel="stylesheet" href="./style/b.css"/>
    
  
</head>
<body class=Docs >
    <div class="ydoc">
      <header class="ydoc-header">
        <div class="ydoc-header-area">
            
            <a href="http://ued.qunar.com/ymfe/" class="navbar-brand">YMFE</a>
            
            <button class="ydocIcon navbar-toggle">&#xf020;</button>
            <nav class="ydoc-nav">
              <ul class="navbar-left">
                
                    
                    <li class="">
                        
                        <a href="index.html">主页</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="GettingStart.html">开始</a>
                        
                    </li>
                    
                    <li class="active">
                        
                        <a href="Docs.html">文档</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="Api.html">Api</a>
                        
                    </li>
                    
                    <li class="">
                        
                        <a href="News.html">新闻</a>
                        
                    </li>
                    
                
              </ul>
            </nav>
        </div>
    </header>
    
    <!-- <header style="height:20px"></header> -->
    
      <!-- Docs page layout -->
      
      <div class="ydoc-banner-bg">
          <div class="ydoc-banner">
              <div class="ydoc-banner-area">
                  <h1>Bigview</h1>
                  <p>A fast, simple & powerful bigpipe framework</p>
              </div>
          </div>
      

      <div class="ydoc-container">
        
        <div class="ydoc-container-content">
            
            <div class="content-left" role="complementary">
              <nav class="docs-sidebar hidden-print hidden-xs hidden-sm">
                <ul class="nav docs-sidenav">
                  
                  
                  <li>
                      <a href="#简介">简介</a>
                  </li>
                  
                  
                  
                  <li>
                      <a href="#概念">概念</a>
                  </li>
                  
                  
                  
                  
                  <ul class="nav docs-sidenav-extend">
                  
                      <li>
                          <a href="#什么是bigpipe">什么是bigpipe</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#能解决的问题">能解决的问题</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#缺点">缺点</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#实现方式">实现方式</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#关键技术点">关键技术点</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#Node-js-bigpipe实现">Node.js bigpipe实现</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#更多">更多</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#参考">参考</a>
                      </li>
                  
                  </ul>
                  
                  
                  
                  
                  <li>
                      <a href="#核心">核心</a>
                  </li>
                  
                  
                  
                  
                  <ul class="nav docs-sidenav-extend">
                  
                      <li>
                          <a href="#bigview">bigview</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#biglet即pagelet">biglet即pagelet</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#渲染模式">渲染模式</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#生命周期">生命周期</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#子模块">子模块</a>
                      </li>
                  
                  </ul>
                  
                  
                  
                  
                  <li>
                      <a href="#高级">高级</a>
                  </li>
                  
                  
                  
                  
                  <ul class="nav docs-sidenav-extend">
                  
                      <li>
                          <a href="#扩展bigview">扩展bigview</a>
                      </li>
                  
                  
                  
                  
                  
                      <li>
                          <a href="#扩展biglet">扩展biglet</a>
                      </li>
                  
                  
                  
                </ul>
              </nav>
            </div>
            
            <div class="content-right right markdown-body"  role="main">
              
              
              
              <div class="docs-section">
                  
                  
                  <h2 id="简介" class="page-header">简介</h2>
                  
                  
                  
                  <div>
                      <p>bigview是采用Node.js实现的bigpipe框架，和微博采用的技术是一样的，唯一的差别是微博使用php作为后端实现的。</p>

                  </div>
                  
              </div>
              
              
              
              <div class="docs-section">
                  
                  
                  <h2 id="概念" class="page-header">概念</h2>
                  
                  
                  
                  <div>
                      <p><code>分块加载技术</code></p>
<h2 id="什么是bigpipe">什么是bigpipe</h2><ul>
<li>存在很久的一种技术</li>
<li>Facebook首创</li>
<li>首屏快速加载的的异步加载页面方案</li>
<li>前端性能优化的一个方向</li>
<li>适合比较大型的，需要大量服务器运算的站点</li>
<li>有效减少HTTP请求</li>
<li>兼容多浏览器</li>
</ul>
<p>与传统Ajax比较</p>
<ul>
<li>减少HTTP请求数：多个模块更新合成一个请求</li>
<li>请求数减少：多个chunk合成一个请求</li>
<li>减少开发成本：前端无需多写JavaScript代码</li>
<li>降低管理成本：模块更新由后端程序控制</li>
<li>URL优雅降级：页面链接使用真实地址</li>
<li>代码一致性：页面加载不劢态刷新模块代码相同</li>
</ul>
<h2 id="能解决的问题">能解决的问题</h2><ul>
<li>下载阻塞</li>
<li>服务器与浏览器算力浪费</li>
</ul>
<p>一句话：<code>分块加载技术</code></p>
<h2 id="缺点">缺点</h2><p>不利于SEO搜索引擎(这个说的不太对，可以采用其他手动弥补的)</p>
<h2 id="实现方式">实现方式</h2><blockquote>
<p>一个重新设计的基础动态网页服务体系。</p>
<p>大体思路是，分解网页成叫做Pagelets的小块，然后通过Web服务器和浏览器建立管道并管理他们在不同阶段的运行。</p>
<p>不需要改变现有的网络浏览器或服务器，它完全使用PHP和JavaScript来实现。(此处是错误的，任何语言都可以实现)</p>
</blockquote>
<h2 id="关键技术点">关键技术点</h2><p>HTTP 1.1引入分块传输编码</p>
<blockquote>
<h3 id="注：HTTP分块传输编码允许服务器为动态生成的内容维持HTTP持久链接。">注：HTTP分块传输编码允许服务器为动态生成的内容维持HTTP持久链接。</h3></blockquote>
<p>HTTP分块传输编码格式</p>
<blockquote>
<p>Transfer-Encoding: chunked
如果一个HTTP消息（请求消息或应答消息）的Transfer-Encoding消息头的值为chunked，那么，消息体由数量未定的块组成，并以最后一个大小为0的块为结束。</p>
</blockquote>
<p>Nodejs自动开启 chunked encoding</p>
<blockquote>
<p>除非通过sendHeader()设置Content-Length头。</p>
</blockquote>
<h2 id="Node.js bigpipe实现">Node.js bigpipe实现</h2><h3 id="使用内置的http模块">使用内置的http模块</h3><pre><code class="lang-js"><span class="token string">'use strict'</span>

<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> ms <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> app <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">writeHead</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'Content-Type'</span><span class="token punctuation">:</span> <span class="token string">'text/html'</span><span class="token punctuation">,</span> <span class="token string">'charset'</span><span class="token punctuation">:</span> <span class="token string">'utf-8'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>

  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'loading...&lt;br>'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 2000ms&lt;br>`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 5000ms&lt;br>`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="关键字">关键字</h4><pre><code>res.write(&#39;xxxx&#39;);
res.write(&#39;xxxx&#39;);
res.write(&#39;xxxx&#39;);
res.end(&#39;xxxx&#39;);
</code></pre><h3 id="Express写法">Express写法</h3><pre><code class="lang-js"><span class="token string">'use strict'</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> ms <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token keyword">var</span> express <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">express</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res<span class="token punctuation">.</span><span class="token function">type</span><span class="token punctuation">(</span><span class="token string">'html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
  res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'loading...&lt;br>'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 2000ms&lt;br>`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 5000ms&lt;br>`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="关键字">关键字</h4><blockquote>
<p>为什么不用res.send?</p>
</blockquote>
<p>因为res.send包括了res.write()和res.end()</p>
<h3 id="Koa写法">Koa写法</h3><p>Koa里没有提供对bigpipe的支持，ctx.body赋值做了很多约定。可以说是不太容易控制。</p>
<ul>
<li>http模块是基于stream的，所以方案1是通过require(&#39;stream&#39;).Readable来处理，这种是非常容易理解，但要求大家对stream有一个比较好的理解。</li>
<li>方案2，反正Koa和express都是基于http模块的，那么为什么不用http模块的方法呢？</li>
</ul>
<p>在Koa里有2个概念非常容易混，req和request，res和response，我们经常在express里用req和res，但在Koa里它们指的是http启动server时传入的req和res参数</p>
<pre><code>var http = require(&quot;http&quot;);

http.createServer((req, res) =&gt; {
    res.writeHead(200, {
        &quot;Content-Type&quot;: &quot;text/plain&quot;
    });
    res.write(&quot;Hello World&quot;);
    res.end();
}).listen(8888);
</code></pre><p>那么是不是可以不用Koa的东西，改用http的接口呢？res.write和express里的res.write是一样的。</p>
<h4 id="Koa 1.x">Koa 1.x</h4><pre><code class="lang-js"><span class="token keyword">var</span> koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> app <span class="token operator">=</span> <span class="token function">koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">var</span> co <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'co'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> Readable <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'stream'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Readable

<span class="token keyword">const</span> sleep <span class="token operator">=</span> ms <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> view <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Readable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  view<span class="token punctuation">.</span>_read <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span>body <span class="token operator">=</span> view
  <span class="token keyword">this</span><span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">'html'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">200</span>

  view<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">'loading...&lt;br>'</span><span class="token punctuation">)</span>

  <span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">yield</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
      view<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 2000ms&lt;br>`</span></span><span class="token punctuation">)</span>
      <span class="token keyword">yield</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
      view<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 5000ms&lt;br>`</span></span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">/** 结束传送 */</span>
      view<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9092</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="Koa 2.x">Koa 2.x</h4><pre><code class="lang-js"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> sleep <span class="token operator">=</span> ms <span class="token operator">=</span><span class="token operator">></span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>r <span class="token operator">=</span><span class="token operator">></span> <span class="token function">setTimeout</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> ms<span class="token punctuation">)</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'koa-bigpipe'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">// response</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ctx <span class="token operator">=</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment" spellcheck="true">// ctx.body = 'Hello Koa'</span>
  ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">'loading...&lt;br>'</span><span class="token punctuation">)</span>

  <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 2000ms&lt;br>`</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token template-string"><span class="token string">`timer: 5000ms&lt;br>`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="问题">问题</h3><blockquote>
<p>为什么是按照顺序加载的,怎么能并发加载呢?</p>
</blockquote>
<ul>
<li>这就需要用到promise了 <code>自行领悟</code></li>
</ul>
<p><a href="https://github.com/lduoduo/bigpipe_demo">@上面三种情况的项目地址</a></p>
<pre><code class="lang-js">    注意<span class="token operator">!</span>
    分块加载的样式和脚本的加载顺序问题：
    <span class="token number">1</span><span class="token punctuation">.</span> 第一次同步给浏览器的内容里如果包含样式和脚本，浏览器会立即请求
    <span class="token number">2</span><span class="token punctuation">.</span> 后续的块状内容异步给浏览器后，对应的模块渲染完成，会立即请求模块里的样式文件
    <span class="token number">3</span><span class="token punctuation">.</span> 上面第二种情况对js不起作用，浏览器只会渲染，不会做请求<span class="token operator">!</span><span class="token operator">!</span>why<span class="token operator">?</span><span class="token operator">?</span>
</code></pre>
<p><a href="https://github.com/lduoduo/mykoa/tree/bigpipe">@上面特殊情况的论证项目地址</a></p>
<h2 id="更多">更多</h2><ul>
<li>模块解耦</li>
<li>前端优化，参考微博的方式</li>
<li>性能改进<ul>
<li>req.js，有http改成rpc</li>
<li>缓存模板</li>
<li>缓存编译结果</li>
</ul>
</li>
<li>BigPipe的三种模式：<ul>
<li>一次渲染模式：即普通模式，支持搜索引擎，用来支持那些不支持JS的客户端。</li>
<li>管线模式：即并行模式，并行请求，并即时渲染。(已实现)</li>
<li>并行模式：并行请求，但在获得所有请求的结果后再渲染。</li>
</ul>
</li>
</ul>
<h2 id="参考">参考</h2><blockquote>
<p><a href="http://velocity.oreilly.com.cn/2011/ppts/WK_velocity.pdf">http://velocity.oreilly.com.cn/2011/ppts/WK_velocity.pdf</a></p>
<p><a href="https://isux.tencent.com/bigpipe-pipelining-web-pages-for-high-performance.html">BigPipe：高性能的“流水线技术”网页</a></p>
<p><a href="https://yuguo.us/weblog/bigpipe-in-nodejs/">nodejs实现bigpipe</a></p>
<p><a href="http://blog.csdn.net/swingboard/article/details/43229895">nodejs 创建http server</a></p>
<p><a href="http://tech.dianwoda.com/2016/10/26/big-pipe-web-page-rendering-acceleration/">koa 和 bigpipe</a></p>
</blockquote>

                  </div>
                  
              </div>
              
              
              
              <div class="docs-section">
                  
                  
                  <h2 id="核心" class="page-header">核心</h2>
                  
                  
                  
                  <div>
                      <h2 id="bigview">bigview</h2><p>针对视图渲染和模块进行的封装，主要用于管理模块和提供生命周期回调。</p>
<h2 id="biglet即pagelet">biglet即pagelet</h2><p>biglet是pagelet的别名，提供了生命周期封装，包括before、fetch、parse、end等，这样更加便于组装带有http接口请求的模块。</p>
<p>由于bigpipe的特点，在特别大的页面里，返回数据优先渲染，保证首屏渲染速度，并且在某些情况下，可以允许某些模块因网络请求或者其他原因的延时显示，甚至不显示也没有问题。</p>
<p>如果模块设计的好</p>
<ul>
<li>无依赖</li>
<li>可以进行独立发布和测试</li>
<li>模块可以有子模块</li>
</ul>
<p>无论出于哪种考虑，biglet都可以非常好的支持。</p>
<h2 id="渲染模式">渲染模式</h2><p>支持5种bigpipe渲染模式</p>
<ul>
<li>parallel.js   并行模式， 先写布局，并行请求，但在获得所有请求的结果后再渲染</li>
<li>pipeline.js  (默认) 管线模式：即并行模式， 先写布局，并行请求，并即时渲染</li>
<li>reduce.js    顺序模式： 先写布局，按照pagelet加入顺序，依次执行，写入</li>
<li>reducerender.js 先写布局，然后顺序执行，在获得所有请求的结果后再渲染</li>
<li>render.js 一次渲染模式：即普通模式，不写入布局，所有pagelet执行完成，一次写入到浏览器。支持搜索引擎，用来支持那些不支持JS的客户端。</li>
</ul>
<h2 id="生命周期">生命周期</h2><p>bigview的生命周期</p>
<ul>
<li>before</li>
<li>.then(this.beforeRenderLayout.bind(this))</li>
<li>.then(this.renderLayout.bind(this))</li>
<li>.then(this.afterRenderLayout.bind(this))</li>
<li>.then(this.beforeRenderPagelets.bind(this))</li>
<li>.then(this.renderPagelets.bind(this))</li>
<li>.then(this.afterRenderPagelets.bind(this)</li>
<li>end</li>
</ul>
<p>bigview的生命周期精简</p>
<ul>
<li>before</li>
<li>renderLayout</li>
<li>renderPagelets</li>
<li>end</li>
</ul>
<p>biglet的生命周期</p>
<ul>
<li>before</li>
<li>.then(self.fetch.bind(self))</li>
<li>.then(self.parse.bind(self))</li>
<li>.then(self.render.bind(self))</li>
<li>end</li>
</ul>

                  </div>
                  
              </div>
              
              
              
              <div class="docs-section">
                  
                  
                  <h3 id="子模块" class="page-header">子模块</h3>
                  
                  
                  
                  <div>
                      <h2 id="子模块">子模块</h2><ul>
<li>支持嵌套</li>
<li>支持子模块渲染模式设置</li>
</ul>

                  </div>
                  
              </div>
              
              
              
              <div class="docs-section">
                  
                  
                  <h2 id="高级" class="page-header">高级</h2>
                  
                  
                  
                  <div>
                      <h2 id="扩展bigview">扩展bigview</h2><p>主要是根据bigview的生命周期来实现某种功能</p>
<pre><code>&#39;use strict&#39;;

const BigView = require(&#39;bigview&#39;);

module.exports = class QBigView extends BigView {
    afterRenderLayout(data) {
        ....
    }
}
</code></pre><h2 id="扩展biglet">扩展biglet</h2><pre><code>&#39;use strict&#39;

const Pagelet = require(&#39;biglet&#39;);

module.exports = class MyPagelet extends Pagelet {
    constructor() {
        super();
        this.root = __dirname;
        this.domid = &#39;reimburse&#39;;
    }

    parse() {
        let pagelet = this;
        return new Promise(function(resolve, reject) {
            return parse(pagelet).then(function (data) {
                resolve(pagelet.data = data);
            });
        });
    }

    fetch() {
        ... 
    };
}
</code></pre>
                  </div>
                  
              </div>
              
              
            </div>
        </div>
        
      </div>
     
     </div>
     
      <footer class="footer">
        <div class="copyright">
            &copy; 2016 <a href="http://ued.qunar.com/ymfe/">YMFE</a> Team. Build by <a href="http://ued.qunar.com/ydoc/">ydoc</a>.
        </div>
      </footer>
    </div>

    
    
    <div class="open-panel"></div>
    

    <script src="source/main.js"></script>
    <script src="source/app.js"></script>
    
    <script>
        var lineHeight = 17.4;
        var EXAMPLE_MAX_HEIGHT;
        function fold(){
            // 折叠code
            $('.markdown-body pre').css({"line-height": lineHeight+"px"});
            $('.markdown-body pre').map(function(i,item){
                var $item = $(item);
                var foldnumber = $item.data('foldnumber');
                EXAMPLE_MAX_HEIGHT = lineHeight * (foldnumber || 6);
                if($item.height() >EXAMPLE_MAX_HEIGHT){
                    $item.css({ "padding-bottom":30 });
                    $item.find('code').height(EXAMPLE_MAX_HEIGHT);
                    $item.append('<span class="extend">展开更多……</span>');
                };
            });
           $('.ydoc-example').delegate('.extend','click',function(){
                var $this = $(this);
                $this.removeClass('extend').addClass('fold');
                $this.html('折叠代码');
                $this.prev().height('auto');
                $this.prev().parent().height('auto');
            });
            $('.ydoc-example').delegate('.fold','click',function(){
                var $this = $(this);
                var foldnumber = $this.parent().data('foldnumber');
                EXAMPLE_MAX_HEIGHT = lineHeight * (foldnumber || 6);
                $this.removeClass('fold').addClass('extend');
                $this.parent().height(EXAMPLE_MAX_HEIGHT);  // pre
                $this.prev().height(EXAMPLE_MAX_HEIGHT);    // code
                $this.html("展开更多……");
            });
        }
        $(document).ready(fold);
    </script>
    
    
    <script>
    var DEFAULT_SHOW_PARAMS = 5;
    $(document).ready(function() {
        // 参数默认显示 5个
        $(".docs-table tbody").each(function(){
           var paramsLength = $(this).find('tr').length,
               paramsArray = $(this).find('tr'),
               curTbody = $(this).parents('.docs-table');

           if(paramsLength > DEFAULT_SHOW_PARAMS){
               curTbody.append('<span class="extend-params">展开更多参数……</span>');
               paramsArray.each(function(index,item){
                   if(index >= DEFAULT_SHOW_PARAMS ){
                       $(this).removeClass('hide-params').addClass('hide-params');
                   }
               });
           }
        });
        $(".docs-table").delegate('.extend-params', 'click',function(){
            $(this).parents('.docs-table').find('.hide-params').addClass('show-params');
            $(this).removeClass('extend-params').addClass('fold-params');
            $(this).html('折叠参数');
        });
        $('.docs-table').delegate('.fold-params','click',function(){
            $(this).removeClass('fold-params').addClass('extend-params');
             $(this).parents('.docs-table').find('.show-params').removeClass('show-params');
            $(this).html("展开更多参数……");
        });
    });
    </script>
    

    
    <script>
        $(document).ready(function(){
            var winWidth = $(window).width(),
                $navExtend = $('.docs-sidenav-extend'),
                $contentLeft = $('.content-left');

            changeHide();
            $(window).on('resize',function(){
                winWidth = $(window).width();
                changeHide();
            })
            function changeHide(){
                if(winWidth>767){
                    var activeInit = $contentLeft.find('.active');
                    $navExtend.hide();
                    $(window).on('scroll',function(){
                        var activeChange = $contentLeft.find('.active');
                        if(activeChange[0] && activeInit !== activeChange){
                            activeInit = activeChange;
                            $navExtend.hide();
                            if(activeChange.parent()[0].tagName === 'UL'){
                                if(activeChange.next()[0] && activeChange.parent()[0].className === 'nav docs-sidenav' && activeChange.next()[0].tagName === 'UL'){
                                    activeChange.next().show();
                                }else if (activeChange.parent()[0].className === 'nav docs-sidenav-extend') {
                                    activeChange.parent().show();
                                }
                            }
                        }
                    })
                }
            }
        })
    </script>
    

    
    
      
      <script type="text/javascript" src="./scripts/a.js"></script>
      
    

</body>
</html>
